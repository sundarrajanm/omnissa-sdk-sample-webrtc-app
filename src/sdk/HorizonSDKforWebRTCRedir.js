/*
 * Copyright (c) 2018 Omnissa, LLC. All rights reserved.
 * This product is protected by copyright and intellectual property laws in the
 * United States and other countries as well as by international treaties.
 * -- Omnissa Restricted
 */
/**
 *
 * HorizonSDKforWebRTCRedir.js
 * Build: 13573728282
 *
 */
!function(e){("function"!=typeof define||!define.amd)&&"object"==typeof module&&module.exports?module.exports=e():window.HorizonWebRtcRedirectionAPI=e()}(function(e,t){"use strict";var S={createInstance:30,createInstanceResult:31,newVideoElement:32,removeVideoElement:33,updateVideoElement:34,newFrame:36,removeFrame:37,version:40,enumDevices:41,enumVideoDevice:42,createPeerConnection:43,createOffer:44,createAnswer:45,setLocalDescription:46,setRemoteDescription:47,addIceCandidate:48,addStream:49,getLocalStreams:50,getStats:51,removeStream:52,close:53,getUserMediaShim:54,mediaTrkStop:55,trackEnabled:56,newAudioElement:57,setSinkId:58,updateSrcObject:59,notifyAudio:60,mediaStreamClone:61,mediaTrackClone:62,getDisplayMediaShim:63,setDefaultSinkId:64,shimLogToWebSocket:65,insertDTMF:66,getReceivers:67,customClipRect:69,applyConstraints:70,getScreens:71,setScreenId:72,addTrack:74,removeTrack:75,senderCmd:76,createMediaStream:77,connectedStateChanged:78,updateObjectFit:79,transceiverCmd:300,dataChannelCmd:301,dataChannelEvent:302,getHWND:309},C={ERROR:0,WARN:1,INFO:2,DEBUG:3},G=2,y=0,T=1,_=2,d={DURATION:100,INTERTONEGAP:70},o=0,a=1,f=1,g=2,q="unified-plan",m={TRANSCEIVER_ADD_TRANSCEIVER:1,TRANSCEIVER_SET_CODECPREFERENCE:2,TRANSCEIVER_STOP:3,TRANSCEIVER_SET_DIRECTION:4},l=0,v=1,s=1,c=2,X=4,K=16,u={RPF_ACTIVE:1,RPF_CODEPAYLOADTYPE:2,RPF_DTX:4,RPF_MAXBITRATE:8,RPF_MAXFRAMERATE:16,RPF_PTIME:32,RPF_RID:64,RPF_SCALE_RESOLUTION_DOWNBY:128},Y=0,Z=1,b=0,w=1,Q=4,$=32,ee=2,n="52406081",E="1.0.",k=(E+="@"===n[0]?"00000":n,{UNSUPPORTED:"unsupported",CHROME:"chrome",CHROMIUM_EDGE:"chromium_edge",ELECTRON:"electron"});const O="0";function te(e){setTimeout(e,0)}function ne(e){if(!e||!e.ownerDocument)return 1;if((t=e.ownerDocument.defaultView)&&"function"==typeof t.getZoomFactor)return t.getZoomFactor(e);var{innerWidth:e,outerWidth:t}=t;if(0===e)return t;var n=document.body&&document.body.clientWidth?document.body.clientWidth:e;let i,r;return x==k.ELECTRON?i=Math.round((t-(e-n))/e*1e3)/1e3:x==k.CHROME||x==k.CHROMIUM_EDGE?(i=(t-8)/e*100,r=we(i),Math.round(r||i)/100):1}function ie(e){var t;F.multiwindow&&j?(t=ye(e))?be[t]?L.debug("ensureFrame skipped due to frame already registered."):(j.send({cmd:"newFrame",frame:t,browser:x,customClipRect:1},-1),be[t]=e):L.debug("ensureFrame skipped due to no frameWnd"):L.debug("ensureFrame skipped due to feature not enabled or no connection.")}var re,p=-1,R=-1,oe=-1,ae=0,se=0,de=0,ce=0,ue=0,le=0,i={},I={},P={},he={},fe={},ge=window.navigator.mediaDevices.enumerateDevices,ve=null,D={},pe={},M={},me={},j=null,r=null,A=[],V=[],F={},be={},N={},Se={},Ce=[],x=0<navigator.userAgent.indexOf("Electron")?k.ELECTRON:0<navigator.userAgent.indexOf("Chrome")?0<navigator.userAgent.indexOf("Edg")?k.CHROMIUM_EDGE:k.CHROME:k.UNSUPPORTED,L={logLevel:C.DEBUG,websocketlogLevel:C.INFO,logToConsole:!0,updateLogLevel:function(e,t){L.logLevel=e,L.websocketlogLevel=t},error:function(e){L.log("ERROR",e),r&&"function"==typeof r.error&&r.error(e)},warn:function(e){L.log("WARN",e),r&&"function"==typeof r.warn&&r.warn(e)},info:function(e){L.log("INFO",e),r&&"function"==typeof r.info&&r.info(e)},debug:function(e){L.log("DEBUG",e)},log:function(e,t){try{C[e]<=L.logLevel&&(L.logToConsole&&console&&("object"==typeof t?console.log(t):console.log(e+": "+t)),"string"==typeof t)&&C[e]<=L.websocketlogLevel&&j&&j.sendLogToWebSocket(t,e)}catch(e){}}},ye=function(e){return e},we=function(e){for(var t=[25,33,50,67,75,80,90,100,110,125,150,175,200,250,300,400,500],n=0;n<t.length;n++){var i=t[n],r=.05*i;if(Math.abs(i-e)<r)return i}};function Re(e,t,n){var i,r,o="_id#",a=e.indexOf(t);return-1==a?e+t+"1"+o+n:(i=e.substring(0,a),r=e.indexOf(o,a+t.length),e=Number(e.substring(a+t.length,r)),i+t+((e=isNaN(e)?0:e)+1)+o+n)}function Te(e,t){function n(){return 1<=arguments.length&&"function"==typeof arguments[0]}function i(){return 2<=arguments.length&&"function"==typeof arguments[1]}function r(a,s,d,c){return new Promise(function(e,t){var n=new DOMException("createOffer cancelled","OperationError"),i=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),r=a?e:d,o=a?t:c;j.send({cmd:"createOffer",options:s},u.id,function(e){I[u.id]?void 0===e.error?(L.debug("createOffer done"),L.debug(e.desc),e.transceivers&&v(e.transceivers),r(e.desc)):o(n):o(i)})})}function o(a,s,d,c){return new Promise(function(e,t){var n=new DOMException("createAnswer cancelled","OperationError"),i=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),r=a?e:d,o=a?t:c;j.send({cmd:"createAnswer",options:s},u.id,function(e){I[u.id]?void 0===e.error?(L.debug("createAnswer done"),L.debug(e.desc),e.transceivers&&v(e.transceivers),r(e.desc)):o(n):o(i)})})}function a(a,s,d,c){return u._remoteDescription=s,new Promise(function(e,t){var n=new DOMException("setRemoteDescription cancelled","OperationError"),i=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),r=a?e:d,o=a?t:c;j.send({cmd:"setRemoteDescription",desc:s},u.id,function(e){I[u.id]?void 0===e.error?(e.transceivers&&v(e.transceivers,e.transceiversRemoved),r()):o(n):o(i)})})}function s(a,s,d,c){return u._localDescription=s,new Promise(function(e,t){var n=new DOMException("setLocalDescription cancelled","OperationError"),i=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),r=a?e:d,o=a?t:c;j.send({cmd:"setLocalDescription",desc:s},u.id,function(e){I[u.id]?void 0===e.error?(e.transceivers&&v(e.transceivers,e.transceiversRemoved),r()):o(n):o(i)})})}function d(a,s,d,c){return new Promise(function(e,t){var n=new DOMException("addIceCandidate cancelled","OperationError"),i=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),r=a?e:d,o=a?t:c;j.send({cmd:"addIceCandidate",candidate:s},u.id,function(e){I[u.id]?void 0===e.error?r():o(n):o(i)})})}function c(i,r){return new Promise(function(e,t){new DOMException("getStats cancelled","InvalidAccessError");var n=i?e:r,e={cmd:"getStats"};i==w&&(e.capability=Q),j.send(e,u.id,function(e){var t;"function"==typeof n&&(void 0===e.error&&void 0!==e.stats&&void 0!==I[u.id]?i==w?n(e.stats):((t=new _e)._create(e.stats),n(t)):n({}))})})}var u=this,l={},h={},f={},g=!1,v=(this.id=++oe,this._localStreams=[],this._remoteStreams=[],this._dataChannelMap={},this._dataChannelIdToShimIdMap={},this._iceConnectionState="new",e&&e.sdpSemantics===q&&(g=!0),this.isUnifiedPlan=function(){return g},Object.defineProperty(this,"iceConnectionState",{get:function(){return L.debug("get iceConnectionState:"+this._iceConnectionState),this._iceConnectionState},configurable:!0}),this._iceGatheringState="new",Object.defineProperty(this,"iceGatheringState",{get:function(){return L.debug("get iceGatheringState:"+this._iceGatheringState),this._iceGatheringState},configurable:!0}),this._signalingState="stable",Object.defineProperty(this,"signalingState",{get:function(){return L.debug("get signalingState:"+this._signalingState),this._signalingState},configurable:!0}),this._connectionState="new",F.connectionState&&Object.defineProperty(this,"connectionState",{get:function(){return L.debug("get connectionState:"+this._connectionState),this._connectionState},configurable:!0}),this._localDescription=null,Object.defineProperty(this,"localDescription",{get:function(){return L.debug("get localDescription:"+this._localDescription),this._localDescription},configurable:!0}),this._remoteDescription=null,Object.defineProperty(this,"remoteDescription",{get:function(){return L.debug("get remoteDescription:"+this._remoteDescription),this._remoteDescription},configurable:!0}),this.cleanUp=function(){var e,t;"complete"!==this._iceGatheringState&&(t={type:"icecandidate",candidate:null,target:this},this.onicecandidate&&this.onicecandidate(t),this._iceGatheringState="complete",e={type:"icegatheringstatechange",target:this},this.onicegatheringstatechange)&&this.onicegatheringstatechange(e),"disconnected"!=this._iceConnectionState&&(this._iceConnectionState="disconnected",t={type:"iceconnectionstatechange",target:this},this.oniceconnectionstatechange)&&this.oniceconnectionstatechange(t),this._localStreams=[],this._remoteStreams=[]},this.createOfferV0=function(e,t,n){r(b,n,e,t)},this.createOfferV1=function(){return n.apply(null,arguments)?this.createOfferV0.apply(this,arguments):r(w,arguments[0])},this.createAnswerV0=function(e,t,n){o(b,n,e,t)},this.createAnswerV1=function(){return n.apply(null,arguments)?this.createAnswerV0.apply(this,arguments):o(w,arguments[0])},this.setRemoteDescriptionV0=function(e,t,n){a(b,e,t,n)},this.setRemoteDescriptionV1=function(){return i.apply(null,arguments)?this.setRemoteDescriptionV0.apply(this,arguments):a(w,arguments[0])},this.setLocalDescriptionV0=function(e,t,n){s(b,e,t,n)},this.setLocalDescriptionV1=function(){return i.apply(null,arguments)?this.setLocalDescriptionV0.apply(this,arguments):s(w,arguments[0])},this.addIceCandidateV0=function(e,t,n){d(b,e,t,n)},this.addIceCandidateV1=function(){return i.apply(null,arguments)?this.addIceCandidateV0.apply(this,arugments):d(w,arguments[0])},this.createDTMFSender=function(e){var t;return"audio"!==e.kind?(L.error("DTMF only could be associated with audio track."),null):((t=new Ee).initPlanB(u.id,e),fe[e.id]=t)},this.getStatsV0=function(e){return c(b,e)},this.getStatsV1=function(){return n.apply(null,arguments)?this.getStatsV0.apply(this,arguments):c(w)},this.getLocalStreams=function(){return g?(L.warn("getLocalStreams is not supported in the unified plan, use getSenders()"),[]):(L.debug("getLocalStreams():"+this._localStreams.length),this._localStreams)},this.getRemoteStreams=function(){return g?(L.warn("getRemoteStreams is not supported in the unified plan, use getReceivers()"),[]):(L.debug("getRemoteStreams():"+this._remoteStreams.length),this._remoteStreams)},this.addStream=function(e){this._localStreams.push(e),j.send({cmd:"addStream",sid:e.id},u.id)},this.removeStream=function(e){L.debug("RTCPeerConnection.removeStream(): "+e.id);var t=this._localStreams.indexOf(e);-1!=t?this._localStreams.splice(t,1):L.error("RTCPeerConnection.removeStream(): Failed to find stream: "+e.id),j.send({cmd:"removeStream",sid:e.id},u.id)},this.addTrackImplV1=function(e,t){var n,i;if(e&&t)return g?((n=new W(u)).initTrackOrKind(e),(i=(f[n.id]=n).sender).setTrack(e,t),j.send({cmd:"addTrack",transceiverId:n.id,tid:e.id,sid:t.id},u.id,function(e){void 0===e.error?v(e.transceivers):delete f[n.id]})):(i=h[e.id])?L.warn("RTCPeerConnection.addTrack: sender already exists."):((i=new J(u)).initPlanB(e,t),h[i.id]=i,j.send({cmd:"addTrack",transceiverId:"",tid:e.id,sid:t.id},u.id,function(e){void 0!==e.error&&delete h[i.id]})),i;throw new Error("both media track and stream need to be provided")},this.removeTrackImplV1=function(e){e?void 0===e._cap?L.error("sender object doesn't have the capability bits"):e.id?(e.removeTrack(),g||delete h[e.id]):L.error("RTCPeerConnection.removeTrack: not a valid sender object"):L.error("RTCPeerConnection.removeTrack: invalid sender.")},this.getSendersImplV1=function(){L.debug("RTCPeerConnection.getSendersImplV1");var e=[];if(g)for(var t in f){var n=f[t].sender;n&&e.push(n)}else for(var t in h)h[t]&&e.push(h[t]);return e},this.getTranceiversImplV1=function(){L.debug("RTCPeerConnection.getTranceiversImplV1");var e,t=[];for(e in f)L.debug("RTCPeerConnection.getTranceiversImplV1 id="+e),t.push(f[e]);return t},this.addTransceiverImplV1=function(e,t){var n=new W(u),i=(n.initTrackOrKind(e,t),f[n.id]=n,{cmd:"transceiverCmd",transceiverCmd:m.TRANSCEIVER_ADD_TRANSCEIVER,hint:"RTCRtpTransceiver.addTransceiver",transceiverId:n.id});if("audio"===e||"video"===e)i.trackOrKind=e;else{if(!(e instanceof B))return L.error("addTranceiver: Unknown type"),null;L.debug("addTranceiver with track is not Implemented"),i.trackOrKind=e.id}e={};if(t.direction&&(e.direction=t.direction),t.sendEncodings&&(e.sendEncodings=t.sendEncodings),t.streams){for(var r in streamIds=[],t.streams)streamIds.push(r.id);e.streams=streamIds}return i.init=e,j.send(i,u.id,function(e){void 0===e.error&&v(e.transceivers)}),n},this.createDataChannelImplV1=function(e,t){var n,i;return L.debug("RTCPeerConnection.createDataChannel: "+e+" option: "+JSON.stringify(this.options)),e?(n=++le,(i=new De(u.id,n))._createChannel(e,t),u._dataChannelMap[n]=i):(L.error("RTCPeerConnection.createDataChannel: missing label"),null)},this._untrackDataChannel=function(e,t){void 0!==t&&u._dataChannelMap[t]&&(L.debug("Untrack datachannel: "+e+" shimId: "+t),delete u._dataChannelMap[t]),e!=R&&u._dataChannelIdToShimIdMap[e]&&(L.debug("Remove mapped datachannel: "+e+" shimId:"+t),delete u._dataChannelIdToShimIdMap[e])},function(e,t){for(var n in e){var i,r=e[n],o=f[r.id];(o||(o=r.id,L.debug("_updateTransceivers: addTransceiver id="+o),(i=new W(u)).initId(o),f[o]=i)).update(r)}if(t)for(var n in t){var a=t[n];L.debug("_updateTransceivers: removeTransceiver id="+a),delete f[a]}}),p=(this.close=function(){p=null,j.send({cmd:"close"},u.id,function(e){delete I[u.id]},!0)},null);this.getReceivers=function(){if(g){var e=[];if(f)for(var t in f){var n=f[t].receiver;n&&e.push(n)}}else{p||(p={},j.send({cmd:"getReceivers"},u.id,function(e){},!0));e=[];for(t in p)p[t]&&e.push(p[t])}return e},this.addEventListener=function(e,t){L.debug("RTCPeerConnection.addEventListener(): "+e),"function"!=typeof t?L.error("RTCPeerConnection.addEventListener(): The listener handler is invalid."):"string"!=typeof e?L.error("RTCPeerConnection.addEventListener(): The event name is invalid."):(void 0===l[e]&&(l[event]={listeners:[]}),l[e].listeners.push(t))},this.removeEventListener=function(e,t){L.debug("RTCPeerConnection.removeEventListener(): "+e),void 0===l[e]?L.error("RTCPeerConnection.removeEventListener(): Event does not exist = "+e):l[e].listeners=l[e].listeners.filter(function(e){return e.toString()!==t.toString()})},this._onReceiveDataChannelEvent=function(e){var t;void 0===e.shimId?L.error("RTCPeerConnection._onReceiveDataChannelEvent: missing shimId"):((t=e.shimId)==R&&e.channel&&void 0!==e.channel.id&&(L.debug("Try to find mapped "+e.channel.id+" in:"+JSON.stringify(u._dataChannelIdToShimIdMap)),void 0!==u._dataChannelIdToShimIdMap[e.channel.id])&&(t=u._dataChannelIdToShimIdMap[e.channel.id],L.debug("RTCPeerConnection._onReceiveDataChannelEvent: use mapped shimId: "+t)),t!=R&&u._dataChannelMap[t]?u._dataChannelMap[t]._onReceiveEvent(e):L.error("RTCPeerConnection._onReceiveDataChannelEvent: dataChannle "+t+" not existed"))},this._onReceiveEvent=function(e){if(void 0===e||void 0===e.evt)L.error("_onReceiveEvent(): evt property is invalid.");else{var t={type:e.evt,target:this};switch(e.details&&this._updateVars(e.details),e.evt){case"connectionstatechange":this.onconnectionstatechange&&this.onconnectionstatechange(t);break;case"negotiationneeded":this.onnegotiationneeded&&this.onnegotiationneeded(t);break;case"icecandidate":t.candidate=e.candidate,this.onicecandidate&&this.onicecandidate(t);break;case"icegatheringstatechange":this.onicegatheringstatechange&&this.onicegatheringstatechange(t);break;case"iceconnectionstatechange":this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t);break;case"signalingstatechange":this.onsignalingstatechange&&this.onsignalingstatechange(t);break;case"ondatachannel":e.channel?this.ondatachannel&&(r=++le,o=new De(u.id,r),void 0!==e.channel.id&&(L.debug("ondatachannel shimId: "+e.channel.id+" mapped to "+r),u._dataChannelIdToShimIdMap[e.channel.id]=r),(u._dataChannelMap[r]=o)._updateChannel(e.channel),t.channel=o,L.debug("ondatachannel shimId: "+r+" channel:"+JSON.stringify(e.channel)),this.ondatachannel(t)):L.warn("ondatachannel from legacy client");break;case"addStream":void 0===e.stream?L.debug("_onReceiveEvent(): stream property is invalid."):(t.stream=new U,t.stream._create(e.stream,e.peer),this._remoteStreams.push(t.stream),this.onaddstream&&this.onaddstream(t));break;case"removeStream":void 0===e.stream?L.debug("_onReceiveEvent(): stream property is invalid."):(t.stream=he[e.stream],void 0===t.stream?L.debug("_onReceiveEvent(): no stream found."):(-1!=(o=this._remoteStreams.indexOf(t.stream))&&(e.trackId&&t.stream.removeTrackById(e.trackId),this._remoteStreams.splice(o,1)),this.onremovestream&&this.onremovestream(t)));break;case"ontrack":void 0===e.transceiver||void 0===e.stream?L.error("_onReceiveEvent ontrack property is invalid"):(n=e.transceiver.id,(i=f[n])||(L.debug("ontrack: add transceiver id="+n),(i=new W(u)).initId(n),f[n]=i),i.update(e.transceiver),(r=new U)._create(e.stream,e.peer),this._remoteStreams.push(r),t.transceiver=i,t.receiver=i.receiver,t.streams=[r],t.track=r.track[0],this.ontrack&&this.ontrack(t));break;case"tonechange":var n,i,r,o=null;(o=g?(n=e.transceiverId,(r=(i=f?f[n]:null)?i.sender:null)?r.dtmf:null):fe[e.tid])?o.ontonechange&&o.ontonechange(e):L.debug("_onReceiveEvent(): tonechange, dtmfId is invalid  or not found.");break;case"onreceivers":(n=e.receivers)&&n.forEach(function(e){var t,n;e.id&&(t=e.id,"-"===e.op?delete p[t]:("+"===e.op&&delete p[t],(n=p[t])||(n=new z,p[t]=n),n.update(e)))});break;case"onsenders":(i=e.senders)&&i.forEach(function(e){var t=h[e.id];t&&t.update(e)});break;case"ontransceivers":v(e.transceivers)}}},this._updateVars=function(e){e.iceConnectionState&&(this._iceConnectionState=e.iceConnectionState),e.iceGatheringState&&(this._iceGatheringState=e.iceGatheringState),e.signalingState&&(this._signalingState=e.signalingState),e.connectionState&&(this._connectionState=e.connectionState),e.localDescription&&(this._localDescription=e.localDescription),e.remoteDescription&&(this._remoteDescription=e.remoteDescription)}}function _e(){this.reports=[],this.result=function(){return this.reports},this._create=function(e){var n=this;e.forEach(function(e){var t=new Me;t._create(e),n.reports.push(t)})}}function Ee(){this.canInsertDTMF=!0;var r=void 0,o=null,t="",a=null,s=null;this.initPlanB=function(e,t){r=e,o=t},this.initUnifiedPlan=function(e,t,n,i){t&&n?(r=e,o=i,a=t,s=n):L.error("RTCDTMFSender.initUnifiedPlan: invalid transceiver or sender")},Object.defineProperty(this,"toneBuffer",{get:function(){return L.debug("get DTMF tone buffer"+t),t},set:function(e){void 0===e&&L.warn("Set RTCDTMFSender.toneBuffer to undefined."),L.debug("set DTMF tone buffer"+e),t=e},configurable:!0}),this.insertDTMF=function(e,t,n){L.debug("insertDTMF audio tones: "+e),void 0===t&&(L.debug("Duration is not set, use default"),t=d.DURATION),void 0===n&&(L.debug("Gap is not set, use default"),n=d.INTERTONEGAP),j.send({cmd:"insertDTMF",transceiverId:a?a.id:"",senderId:s?s.id:"",tid:o.id,tones:e,duration:t,gap:n},r)}}function W(e){function t(e){L.info(e+"("+i+")")}var i,r=this,o=e,n="inactive",a="inactive",s=null,d=!1,c=null,u=null;this.initId=function(e){i=e,(c=new J(o)).initUnifiedPlan(r,null),u=new z},this.initTrackOrKind=function(e,t){var e=e instanceof B?e.kind:e,n="";"audio"===e?n="A":"video"===e&&(n="V"),i="Transceiver#"+n+ue.toString(),ue++,(c=new J(o)).initUnifiedPlan(r,t),u=new z,t&&t.direction&&(a=t.direction),t&&t.stream&&L.debug("RTCRtpTransceiver.init with stream is not implemented.")},this.update=function(e){e.currentDirection&&(n=e.currentDirection),e.direction&&(a=e.direction),e.mid&&(s=e.mid),void 0!==e.stopped&&(d=e.stopped),e.sender&&c&&c.update(e.sender),e.receiver&&u&&u.update(e.receiver)},Object.defineProperty(this,"id",{get:function(){return i},configurable:!0}),Object.defineProperty(this,"mid",{get:function(){return t("RTCRtpTransceiver.mid="+s),s}}),Object.defineProperty(this,"currentDirection",{get:function(){return t("RTCRtpTransceiver.currentDirection"),n},configurable:!0}),Object.defineProperty(this,"direction",{get:function(){return t("RTCRtpTransceiver.direction="+a),a},set:function(e){t("RTCRtpTransceiver.direction setter"),a=e;e={cmd:"transceiverCmd",transceiverCmd:m.TRANSCEIVER_SET_DIRECTION,hint:"RTCRtpTransceiver.direction",transceiverId:i,value:e};j.send(e,o.id)},configurable:!0}),Object.defineProperty(this,"receiver",{get:function(){return t("RTCRtpTransceiver.receiver"),u},configurable:!0}),Object.defineProperty(this,"sender",{get:function(){return t("RTCRtpTransceiver.sender"),c},configurable:!0}),Object.defineProperty(this,"stopped",{get:function(){return t("RTCRtpTransceiver stopped"),d},set:function(e){t("RTCRtpTransceiver stopped setter"),d=e},configurable:!0}),this.setCodecPreferences=function(e){t("RTCRtpTransceiver setCodecPreferences"),j.send({cmd:"transceiverCmd",transceiverCmd:m.TRANSCEIVER_SET_CODECPREFERENCE,hint:"RTCRtpTransceiver.setCodecPreference",transceiverId:i,codecs:e},o.id,function(e){void 0!==e.error&&t("RTCRtpTransceiver.setCodecPreferences failed.")})},this.stop=function(){t("RTCRtpTransceiver stop"),j.send({cmd:"transceiverCmd",transceiverCmd:m.TRANSCEIVER_STOP,hint:"RTCRtpTransceiver.stop",transceiverId:i},o.id,function(e){void 0!==e.error&&t("RTCRtpTransceiver.stop failed.")})}}function ke(t,e){var r=this,n=e;this._srcObject=t.srcObject,this._id=se++,this._rawAudio=t,this.sendAudioElement=function(){var e={cmd:"newAudioElement",audioId:this._id};t.setAttribute("data-vdi_audioid",this._id),j.send(e,-1)},Object.defineProperty(t,"srcObject",{get:function(){return r._srcObject},set:function(e){void 0===e&&L.warn("Set audio.srcObject to undefined."),L.debug("Setting srcObject for audio element: "+r._id),L.debug(e),r._srcObject=void 0===e?null:e,r.sendSrcObject()},configurable:!0}),this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null",t=this._srcObject?this._srcObject.peer:p;j.send({cmd:"updateSrcObject",mediaStreamId:e,audioId:this._id,type:"audio",streamPeer:t},-1)},Object.defineProperty(t,"sinkId",{get:function(){return r._sinkId},set:function(e){},configurable:!0}),t.setSinkId=function(i){return r._sinkId=i,L.debug("Audio.setSinkId for ID = "+r._id+" Value = "+i),0===(void 0!==F.setSinkId?F.setSinkId:0)?new Promise(function(e,t){j.send({cmd:"setSinkId",deviceId:i,audioId:r._id,context:"audioElement"},-1),e()}):new Promise(function(t,n){j.send({cmd:"setSinkId",deviceId:i,audioId:r._id,context:"audioElement"},-1,function(e){void 0===e.error?t():n(e.error)})})},t.play=function(){return Promise.resolve()},this.init=function(){ie(n),this.sendAudioElement(),this._srcObject&&(L.debug("srcObject already set for audio: "+this._id),this.sendSrcObject()),L.debug(t)},this.init()}function Oe(r,e){var t=this,n=e,o=ye(e),i=!1,s=(this._srcObject=r.srcObject,this._videoWidth=r.videoWidth,this._videoHeight=r.videoHeight,this._cloaked=!1,this._id=ae++,this._clientRect=null,this._bodyClientRect=null,this._colorKey=null,this._rawVideo=r,this._removeTimer=null,this._removed=!1,this._objectFit=r.style.objectFit,this._transform,this._dpiServerTranslate=!!F.multiwindow&&0!=(F.multiwindow&ee),this._styleObserver=new MutationObserver(function(e){e.forEach(function(e){t.handleStyleChanges(e,r)})}),function(e){e=Number(e).toString(16);return e=e.length<2?"0"+e:e});this.sendVideoElement=function(){this._colorKey=function(){for(var e="";""==e;){var t,n=Math.floor(16*Math.random())+1,i=Math.floor(16*Math.random())+1,r=Math.floor(16*Math.random())+1,e="#"+s(n)+s(i)+s(r),o=Object.keys(D);for(t in o){var a=D[o[t]];if(a&&a._colorKey==e){e="";break}}}return e}();var e,t={cmd:"newVideoElement",videoId:this._id,colorKey:this._colorKey,requestDpiTranslate:this._dpiServerTranslate?1:0,body:{},zoomFactor:ne(this._rawVideo)};for(e in o&&(t.frame=o),this._clientRect)t[e]=this._clientRect[e];for(e in this._bodyClientRect)t.body[e]=this._bodyClientRect[e];""!==this._objectFit&&(t.objectFit=this._objectFit),r.setAttribute("data-vdi_videoid",this._id),r.setAttribute("data-vmw_videoid",this._id),j.send(t,-1)},this.updateVideoElement=function(){var e=this.getBoundingClientRect(r),t=(this._cloaked||(e.right=e.left,e.bottom=e.top),this.getBoundingClientRect(document.body));if(e.left==this._clientRect.left&&e.right==this._clientRect.right&&e.top==this._clientRect.top&&e.bottom==this._clientRect.bottom&&t.left==this._bodyClientRect.left&&t.right==this._bodyClientRect.right&&t.top==this._bodyClientRect.top&&t.bottom==this._bodyClientRect.bottom)return!1;this._clientRect=e,this._bodyClientRect=t;var n,i={cmd:"updateVideoElement",videoId:this._id,requestDpiTranslate:this._dpiServerTranslate?1:0,transform:r.style.transform,body:{}};for(n in o&&(i.frame=o),e)i[n]=e[n];for(n in t)i.body[n]=t[n];""!==this._objectFit&&(i.objectFit=this._objectFit),i.zoomFactor=ne(this._rawVideo),L.debug(i),j.send(i,-1)},this.removeVideoElement=function(){var e={cmd:"removeVideoElement",videoId:t._id};o&&(e.frame=o),L.debug("RemoveVideoElement: "+t._id),j.send(e,-1),delete D[t._id],t._removeTimer=null,t._removed=!0},this.disposeVideo=function(){i=!0},this.cloak=function(){!0!==this._cloaked&&(this._colorKey?(r.style.backgroundColor=this._colorKey,this._styleObserver.observe(r,{attributes:!0,attributeFilter:["style"]}),this._cloaked=!0,this._poll=setInterval(function(){t.updateVideoElement()},500)):L.error("cloak(): Invalid color key."))},this.uncloak=function(){if(!1===this._cloaked)return!1;r.style.backgroundColor="",this._styleObserver.disconnect(),clearInterval(this._poll),this._cloaked=!1,this.updateVideoElement()},this.getBoundingClientRect=function(e){var e=e.getBoundingClientRect(),t=1;return this._dpiServerTranslate||"number"!=typeof window.devicePixelRatio||(t=window.devicePixelRatio),{left:e.left*t,top:e.top*t,bottom:e.bottom*t,right:e.right*t,width:e.width*t,height:e.height*t}},this.onReceiveEvent=function(e){var t;void 0===e||void 0===e.evt?L.error("onReceiveEvent(): evt property is invalid."):this._rawVideo?"loadedmetadata"===e.evt&&(""==this._objectFit&&""!==(t=window.getComputedStyle(this._rawVideo).objectFit)&&(L.debug("onReceiveEvent(): updating objectfit to "+t),this._objectFit=t,this.sendObjectFit()),void 0!==e.videoWidth&&(this._videoWidth=e.videoWidth),void 0!==e.videoHeight&&(this._videoHeight=e.videoHeight),t=new Event(e.evt),this._rawVideo.dispatchEvent(t)):L.error("onReceiveEvent(): Invalid rawVideo object.")},this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null",t=this._srcObject?this._srcObject.peer:p;j.send({cmd:"updateSrcObject",mediaStreamId:e,videoId:this._id,type:"video",streamPeer:t},-1),this._srcObject?this.cloak():this.uncloak()},this.sendObjectFit=function(){j.send({cmd:"updateObjectFit",videoId:this._id,objectFit:this._objectFit},-1)},Object.defineProperty(r,"srcObject",{get:function(){return t._srcObject},set:function(e){t._removed?L.warn("Setting srcObject of zombie video element: "+t._id):(t._removeTimer&&(clearTimeout(t._removeTimer),t._removeTimer=null),void 0===e&&L.warn("Set video.srcObject to undefined."),L.debug("Setting srcObject for video element: "+t._id),L.debug(e),t._srcObject=e,t.sendSrcObject(),t._srcObject||(i?t.removeVideoElement():(L.debug("srcObject is null, setup removeTimer for "+t._id),t._removeTimer=setTimeout(t.removeVideoElement,5e3))))},configurable:!0}),Object.defineProperty(r,"videoWidth",{get:function(){return t._videoWidth},configurable:!0}),Object.defineProperty(r,"videoHeight",{get:function(){return t._videoHeight},configurable:!0}),Object.defineProperty(r.style,"objectFit",{get:function(){return console.log("keyword defineProperty get objectFit "+t._objectFit),t._objectFit},set:function(e){console.log("keyword defineProperty set objectFit "+e),t._objectFit=e,t.sendObjectFit()},configurable:!0}),Oe.prototype.handleStyleChanges=function(e,t){"attributes"===e.type&&"style"===e.attributeName&&(L.debug("video style change in id = "+this._id+", object-fit = "+t.style.objectFit),L.debug(t),this._objectFit!==t.style.objectFit&&(L.debug("change in object-fit. Old = "+this._objectFit+", new = "+t.style.objectFit),this._objectFit=t.style.objectFit,this.sendObjectFit()),this._transform!=t.style.transform)&&(this._transform=t.style.transform,this.updateVideoElement())},this.init=function(){this._clientRect=this.getBoundingClientRect(r),this._bodyClientRect=this.getBoundingClientRect(document.body),ie(n),this.sendVideoElement(),this._srcObject&&(L.debug("srcObject already set for video: "+this._id),this.sendSrcObject()),L.debug(r)},this.init()}function H(e){"function"==typeof ve?(L.info("onVMEvent(): Fire event = "+JSON.stringify(e)),ve(e)):L.warn("onVMEvent(): setVMEventCallback is not called yet.")}function Ie(){var a=this,o=null,s=y,w={},d=0,r=null,c=!1,u=void 0,t=!0,n=(Object.defineProperty(this,"state",{get:function(){return s},configurable:!0}),Object.defineProperty(this,"shortPollingIntervalMs",{get:function(){return 500}}),Object.defineProperty(this,"shortPollingTimeout",{get:function(){return 1e4}}),Object.defineProperty(this,"longPollingIntervalMs",{get:function(){return 5e3}}),Object.defineProperty(this,"isHorizonRegistryPresent",{get:function(){return c},set:function(e){c=e},configurable:!0}),Object.defineProperty(this,"sendVdiClientEventsOnError",{get:function(){return t},set:function(e){t=e},configurable:!0}),this.sendLogToWebSocket=function(e,t){return"string"==typeof e&&0!==e.length&&s===_&&(p({cmd:"shimLogToWebSocket",message:e,level:t},-1),!0)},this.isSocketConnected=function(){return s===_},this.isSocketOpen=function(){return!!o&&o.readyState===WebSocket.OPEN},this.init=function(){L.info("RequestManager.init(): Initializing Request Manager."),this.startPolling(500,1e4,this.sendEvents)},this.startPolling=function(e,t,n){var i;L.info("RequestManager.startPolling(): stop the old polling timer(if there is any) and start a new one"),a.stopPolling(),s!==y?L.info("RequestManager.startPolling(): Socket state not disconnected, exiting"):(i=t,L.info("intervalMs "+e+" timeout "+t),r=setInterval(function(){L.info("RequestManager: connectToHorizon"),a.connectToHorizon(),void 0!==i&&(i-=e,c||a.queryHorizonRegistry()),void 0!==i&&i<=0&&(a.stopPolling(),n)&&!0===c&&n()},e))},this.stopPolling=function(){L.info("RequestManager.stopPolling()"),null!==r&&(clearInterval(r),r=null,L.info("Stopped polling websocket"))},this.sendEvents=function(){var e={},e=(e.shimVersion=E,{event:"vdiClientConnected",version:e});try{H(e)}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}try{H({event:"vdiClientDisconnected",reason:"endpointUnsupported"})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}j.startPolling(5e3)},this.queryHorizonRegistry=function(){window.getHorizonClientID().then(function(e){L.info("queryHorizonRegistry(): Horizon Client ID "+e),e&&j&&(j.isHorizonRegistryPresent=!0,L.info("queryHorizonRegistry(): isHorizonRegistryPresent true"))},function(){return L.error("queryHorizonRegistry(): Failed to query Horizon Client ID"),!1})},this.connectToHorizon=function(){s===y&&window.getHorizonWSSPort().then(function(e){"string"!=typeof e||0===e.length?(L.error("connectToHorizon(): Port is not valid"),b("Horizon HTML5 Server port not valid")):(L.info("connectToHorizon(): port is "+e),s=T,(o=new WebSocket("wss://view-localhost:"+e+"/")).binaryType="arraybuffer",o.onopen=h,o.onclose=f,o.onerror=g,o.onmessage=v)},function(){L.error("connectToHorizon(): Failed to receive port number"),b("Failed to receive port number")})},function(){return new Promise(function(e,t){x===k.ELECTRON?(L.error("getWindowHandleByTitle: function called on unsupported browser"),t("function called on unsupported browser")):u=setInterval(function(){i(e,t,u)},500)})}),i=function(t,e,n){var i="function"==typeof window.getHorizonWindowTitle?window.getHorizonWindowTitle():document.title;void 0===i?L.error("getWindowHandleByTitle:: cannot find the window with undefined title"):a.send({cmd:"getHWND",title:i},-1,function(e){void 0===e.error&&void 0!==e.hwnd&&e.hwnd!=O?(L.debug("getWindowHandleByTitle: received window handle"+e.hwnd),clearInterval(n),u=void 0,t(e.hwnd)):L.error("getWindowHandleByTitle:: cannot find the window that matches the title"+e.error)})},l=async function(e,t){e===O&&(L.info("Start polling window from server"),e=await n()),L.info("window handle ="+e),M.hwnd=e,window.getWindowReference=function(){return Promise.resolve(M.hwnd)},H(t)},h=function(){L.info("onWebSocketOpen(): Websocket opened"),j.stopPolling();var e="function"==typeof window.getHorizonWindowTitle?window.getHorizonWindowTitle():document.title;p({cmd:"createInstance",hwnd:M.hwnd,shimVersion:E,shimMinAgentVersion:1,customClipRect:1,allowFeatureChange:1,supportObjectFit:1,supportE911:0,streamBundleWithPeer:1,sdkConfig:Se,appName:re,appType:G,title:e,browser:x},-1,function(t){if(s!=y){t.uid&&L.info("onWebSocketOpen(): ["+t.uid+"] createInstanceDone"),"true"===t.traceEnabled&&L.updateLogLevel(C.DEBUG,C.DEBUG);var e=["agentOsVersion","clientOsVersion","haVersion","hcVersion","shimVersion","webrtcClientVer","webRTCRedirAgentVersion","webRTCRedirClientVersion"],n={};L.logToConsole=!!t.logToConsole,L.debug("VDI Shim: Log to console = "+L.logToConsole),L.debug("VDI createInstance = "+JSON.stringify(t));for(var i=0;i<e.length;i++)t[e[i]]?(n[e[i]]=t[e[i]],L.debug("onWebSocketOpen(): "+e[i]+" = "+t[e[i]])):L.warn("onWebSocketOpen(): Could not find property "+e[i]);t.clientOsVersion?t.clientOsVersion.startsWith("Win")?n.clientPlatform="Windows":t.clientOsVersion.startsWith("mac")?n.clientPlatform="Mac":t.clientOsVersion.startsWith("Lin")?n.clientPlatform="Linux":(L.error("Unknown client os: "+t.clientOsVersion),n.clientPlatform="Unknown"):(L.error("Missing client os information."),n.clientPlatform="Unknown"),L.debug("onWebSocketOpen(): clientPlatform = "+n.clientPlatform);var r={event:"vdiClientConnected",version:n};if(t.hcId&&(r.endpointId=t.hcId,L.debug("onWebSocketOpen(): ClientId = "+t.hcId)),"true"===t.allow&&"Mac"!==n.clientPlatform&&"Unknown"!==n.clientPlatform){s=_,F=t["api-capabilities"]||{},N=t.rtpCapabilities||{},Ce=t.callConfigs||[],Array.isArray(t.featuresSupported)?(A=t.featuresSupported,L.info("onWebSocketOpen(): Supported features = "+JSON.stringify(A))):L.warn("onWebSocketOpen(): featureSupported property not valid");try{M.hwnd!==O?H(r):te(function(){var e=t.hwnd||O;l(e,r)})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}a.invokeDeviceChange()}else{try{H(r)}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}for(var o="",e=["errorCode","errorMsg"],i=0;i<e.length;i++)void 0!==t[e[i]]?(L.debug("onWebSocketOpen(): "+e[i]+": "+t[e[i]]),o+=e[i]+" = "+t[e[i]],i!=e.length-1&&(o+="; ")):L.warn("onWebSocketOpen(): Could not find property "+e[i]);try{H({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:o})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}b("Horizon HTML5 Server connection not allowed")}}})},f=function(){L.info("onWebSocketClose(): Websocket closed"),b("Horizon HTML5 Server connection closed")},g=function(e){L.debug("onWebSocketError(): Websocket error");var t=y;j&&(t=j.state),b("Horizon HTML5 Server connection error: "+e.message),t==T&&(L.debug("Error in connecting socket"),j)&&j.sendVdiClientEventsOnError&&(L.error("Error in connecting to websocket"),j.stopPolling(),j.sendEvents(),j.sendVdiClientEventsOnError=!1)},v=function(e){if("object"==typeof e.data){var t=new Uint8Array(e.data),n=new DataView(e.data),i=n.getInt32(0),r=n.getInt32(36);if(1396920910!=i)L.warn("Unsupport binary data: "+i.toString(16));else{F.getScreens&&F.getScreens&$&&L.warn("New client should return string for getScreen.");for(var o=40,a=[];o+12<t.length;){var s=n.getInt32(o),d=(v=n.getInt32(o+4))*(p=n.getInt32(o+8))*4;if(v<0||p<0||o+12+d>t.length){L.warn("Invalid screen "+v+"X"+p+" offs:"+o+" size:"+d+" len:"+t.length);break}o+=12;var c=new Uint8ClampedArray(t.buffer,o,d),u=new ImageData(c,v,p),l=new Pe(s,"Screen "+s,u);o+=d,a.push(l),L.debug("Screen:"+s+": "+v+"X"+p+" offs:"+o+" size:"+d+" len:"+t.length)}var h=w[r];delete w[r],void 0!==h&&"function"==typeof h.responseCb&&h.responseCb(a)}}else if("string"!=typeof e.data)L.error("onWebSocketMessage(): invalid data type: "+typeof e.data);else{var i=e.data,f=JSON.parse(i);if(L.logToConsole&&console.log("onWebSocketMessage(): "+i),"number"==typeof f.id&&0<f.id){h=w[f.id];if(delete w[f.id],h&&"function"==typeof h.responseCb)if("getScreens"!==f.evt||f.screens)h.responseCb(f);else if(f.error)h.responseCb(f);else{var a=[],g="number"==typeof f.screens?f.screens:1;for(s=1;s<=g;s++){for(var v,p,m=4*(v=100)*(p=100),c=new Uint8ClampedArray(m),b=0;b<m;b+=4)c[b]=81,c[b+1]=144,c[b+2]=201,c[b+3]=255;u=new ImageData(c,v,p),l=new Pe(s,"Screen "+s,u);a.push(l)}h.responseCb(a)}}else if(void 0===f.evt)L.error("onWebSocketMessage(): evt property is invalid");else switch(f.evt){case"version":void 0===f.ver?L.error("onWebSocketMessage(): ver property is invalid."):L.info("onWebSocketMessage(): version = "+f.ver);break;case"negotiationneeded":case"icecandidate":case"icegatheringstatechange":case"iceconnectionstatechange":case"signalingstatechange":case"connectionstatechange":case"addStream":case"ontrack":case"tonechange":case"onreceivers":case"onsenders":case"ontransceivers":case"ondatachannel":case"removeStream":void 0!==f.peer&&void 0!==I[f.peer]?I[f.peer]._onReceiveEvent(f):L.error("onWebSocketMessage(): peerConnection is invalid.");break;case"loadedmetadata":void 0!==f.videoId&&void 0!==D[f.videoId]?D[f.videoId].onReceiveEvent(f):L.error("onReceiveCommand(): Invalid context.");break;case"devicechange":var S=new Event("devicechange");navigator.mediaDevices.dispatchEvent(S);break;case"vdiScreenTopologyChanged":try{H({event:"vdiScreenTopologyChanged"})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}break;case"featuresSupportedChanged":for(var b in f.features){var C=f.features[b],y=A.indexOf(C.feature);"+"==C.op&&y<0?A.push(C.feature):"-"==C.op&&0<=y&&A.splice(y,1)}H({event:"vdiFeatureSupportedChanged",reason:f.reason||"endpoint changes supported features"});break;case"vdiE911InfoChanged":f.event="vdiE911InfoChanged",H(f);break;case"powerevent":S=f.eventData;R(S);break;case"dconopen":case"dconbufferedamountlow":case"dconclosing":case"dconerror":case"dconmessage":case"dconclose":void 0!==f.peer&&void 0!==I[f.peer]?I[f.peer]._onReceiveDataChannelEvent(f):L.error("Datachannel event: peerConnection is invalid.")}}},p=function(e,t,n,i){var r;t=null==t?-1:t,void 0===e?(r=new DOMException("Invalid command, operation cancelled","OperationError"),n?n({error:r}):L.error(r)):-1===t||I[t]?(e.feature=3,e.commandId=S[e.cmd],e.id=++d,e.peer=t,e.browser=x,e.player=1,"createInstance"===e.cmd&&(e.uid=2147483647&Date.now(),L.info("sendHelper(): ["+e.uid+"] createInstance")),"createInstance"!==e.cmd&&s!==_||(n&&(i?n():w[e.id]={id:e.id,webCommandId:e.commandId,responseCb:n}),o.send(JSON.stringify(e)))):(r=new DOMException("peer Id is not found, operation cancelled","OperationError"),n?n({error:r}):L.error(r))},m=(this.send=function(e,t,n,i){"getStats"!=e.cmd&&L.debug(JSON.stringify(e)),p(e,t,n,i)},this.invokeDeviceChange=function(){te(function(){L.info("invokeDeviceChange(): Fire devicechange event");var e=new Event("devicechange");navigator.mediaDevices.dispatchEvent(e)})},this.sendBinary=function(e){s===_?o.send(e):L.warn("sendBinary(): WSS is not connected.")},function(){var e=Math.random()*Number.MAX_SAFE_INTEGER,e=Math.floor(e),e="v=0\no=- "+String(e)+" 2 IP4 127.0.0.1\n";return(e+="s=-\n")+"t= 0 0\n"+"a=msid-semantic: WMS"}),R=function(e){if(e==Y)try{L.info("onPowerEvent(): received suspend"),H({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventSuspend"})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}else if(e==Z){L.info("onPowerEvent(): received resume");try{H({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventResume"})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}}else L.error("powerevent: Invalid param.")},b=function(i,e){L.info("cleanup: Clean up all script resources");var t=s;if(s=e?T:y,Object.keys(w).forEach(function(e){var t,n=new DOMException(i,"OperationError");w[e].responseCb?w[e].webCommandId===S.createOffer||w[e].webCommandId===S.createAnswer?(t={desc:{sdp:m()}},L.debug("Resolving createoffer/createAnswer with desc "+t.desc),w[e].responseCb(t)):w[e].responseCb({error:n}):L.error(n)}),w={},o&&o.readyState===WebSocket.OPEN&&s==y&&o.close(),o=null,Object.keys(I).forEach(function(e){I[e].cleanUp()}),I={},Object.keys(P).forEach(function(e){e=P[e];e.onended&&e.onended()}),P={},he={},A=[],V=[],be={},N={},Ce=[],t===_){try{H({event:"vdiClientDisconnected",reason:"endpointDisconnected"})}catch(e){L.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}a.invokeDeviceChange()}F={}}}function Pe(e,t,n,i){var r=this;this.id=e,this.name=t,this.image=n,this.icon=void 0,this.bounds=i||{x:0,y:0,width:0,height:0},this.getId=function(){return L.debug("getId "+r.id),r.id},this.getDeviceId=function(){return L.debug("getDeviceId "+r.id),Fe+"-"+r.id},this.getType=function(){return Ve.Monitor},this.getPreview=function(e,t,n){return L.debug("ScreensAsync getPreview "),new Promise(function(e,t){t()})},this.getPreviewAsync=function(e,t,n){return L.debug("ScreensAsync getPreviewAsync"),n?new Promise(function(e,t){var n=document.createElement("canvas");n.getContext("2d").putImageData(r.image,0,0),e({data:n.toDataURL().replace("data:image/png;base64,","")})}):new Promise(function(e,t){e(r.image)})},this.getDescription=function(){return L.debug("ScreensAsync getDescription "),r.name},this.getIcon=function(e,t){return L.debug("ScreensAsync getIcon"),new Promise(function(e,t){e(r.image)})},this.getAppName=function(){return L.warn("getAppName: not support."),null},this.getBounds=function(){return(r.bounds.width<=0||r.bounds.height<=0)&&L.warn("getBounds: invalid bounds."),r.bounds}}function De(e,t){var s=this,d=(this.id=R,this.binaryType="arraybuffer",this.bufferedAmount=0,this.maxPacketLifeTime=0,this.maxRetransmits=0,this.negotiated=!1,this.ordered=!0,this.protocol="",this.readyState=!1,this.reliable=!0,this.label="",t),c=e,n=0;Object.defineProperty(this,"bufferedAmountLowThreshold",{get:function(){return n},set:function(e){void 0===e&&L.warn("RTCDataChannel bufferedAmountLowThreshold value undefined."),s.id!=R&&j.send({cmd:"dataChannelCmd",hint:"setBufferAmountLowThreshold",dataChannelCmd:h.SET_BUFFER_AMOUNT_LOW_THRESHOLD,dataChannelId:s.id,shimId:d,label:s.label,threshold:e},c),n=e},configurable:!0}),this._createChannel=function(e,t){s.id==R?(s.label=e,j.send({cmd:"dataChannelCmd",hint:"create",label:e,shimId:d,options:t,dataChannelCmd:h.CREATE},c)):L.warn("RTCDataChannel.create channel "+s.id+" already existed")},this._updateChannel=function(e){s.id=e.id,s.binaryType=e.binaryType,s.bufferedAmount=e.bufferedAmount,s.maxPacketLifeTime=e.maxPacketLifeTime,s.maxRetransmits=e.maxRetransmits,s.negotiated=e.negotiated,s.ordered=e.ordered,s.protocol=e.protocol,s.readyState=e.readyState,s.reliable=e.reliable,s.label=e.label},this.send=function(e){if(s.id!=R)if(e instanceof Blob){e.arrayBuffer();e.arrayBuffer().then(function(e){for(var t=new Uint8Array(e),n=t.byteLength,i="",r=0;r<n;r++)i+=String.fromCharCode(t[r]);j.send({cmd:"dataChannelCmd",label:s.label,dataChannelId:s.id,shimId:d,dataChannelCmd:h.SEND,hint:"send",data:window.btoa(i),dataType:"binary",dataLen:n},c)})}else{var t=null,n=0,i="binary";if("string"==typeof e||e instanceof String)t=window.btoa(e),i="string",n=e.length;else{for(var r=new Uint8Array(e),n=r.byteLength,o="",a=0;a<n;a++)o+=String.fromCharCode(r[a]);o&&(t=window.btoa(o))}t?j.send({cmd:"dataChannelCmd",label:s.label,dataChannelId:s.id,shimId:d,hint:"send",dataChannelCmd:h.SEND,data:t,dataType:i,dataLen:n},c):L.warn("RTCDataChannel.send: Unsupported data format")}else L.error("RTCDataChannel.send: invalid datachannel id.")},this.close=function(){I[c]?(j.send({cmd:"dataChannelCmd",hint:"close",label:s.label,dataChannelId:s.id,shimId:d,dataChannelCmd:h.CLOSE},c),I[c]._untrackDataChannel(s.id,d)):L.warn("RTCDataChannel.close: peerconnection is untracked.")},this._onReceiveEvent=function(e){if(void 0===e||void 0===e.evt)L.error("_onReceiveEvent(): evt property is invalid.");else{var t={target:this};switch(e.evt){case"dconopen":this.onopen&&(this._updateChannel(e.channel),this.onopen(t));break;case"dconbufferedamountlow":this.onbufferedamountlow&&this.onbufferedamountlow(t);break;case"dconerror":this.onerror&&this.onerror(t);break;case"dconmessage":if(this.onmessage){if("string"===e.dataType)t.data=window.atob(e.data);else{var n=window.atob(e.data),i=n.length;t.data=new Uint8Array(i);for(var r=0;r<i;r++)t.data[r]=n.charCodeAt(r)}this.onmessage(t)}break;case"dconclose":this.onclose&&this.onclose(t)}}}}var U=function(e){var n=this,i={};this._objectId=++de,this.id="",this.peer=p,this.active=!1,this.ended=!1,this.cloned=null,this.track=[],this.createMediaStream=function(e){void 0===e||Array.isArray(e)?(this.id="Stream#"+n._objectId,L.debug("MediaStream.createMediaStream() with "+n.id+"MediaStreamTracks num ="+!(e=e)?0:e.length),this.active=!1,this.track=[],void 0!==e&&e.forEach(function(e){e&&e instanceof B&&n.track.push(e)}),j.send({cmd:"createMediaStream",sid:n.id,tracks:n.track},-1)):L.debug("MediaStream.createMediaStream failed with invalid parameter")},this._create=function(e,t){this.id=e.id,this.peer=t,this.active=e.active,this.track=[],e.track.forEach(function(e){var t=new B;t._create(e),n.track.push(t)}),he[this.id]=this},this.dispatchEvent=function(t){L.debug("MediaStream.dispatchEvent(): "+t.type),void 0!==i[event.type]&&i[event.type].listeners.forEach(function(e){e(t)}),"active"===t.type?this.onactive&&this.onactive(t):"addtrack"===t.type?this.onaddtrack&&this.onaddtrack(t):"inactive"===t.type?this.oninactive&&this.oninactive(t):"removetrack"===t.type?this.onremovetrack&&this.onremovetrack(t):L.debug("MediaStream.dispatchEvent(): Undefined event: ",t.type)},this.addEventListener=function(e,t){L.debug("MediaStream.addEventListener(): "+e),"function"!=typeof t?L.error("MediaStream.addEventListener(): The listener handler is invalid."):"string"!=typeof e?L.error("MediaStream.addEventListener(): The event name is invalid."):(void 0===i[e]&&(i[event]={listeners:[]}),i[e].listeners.push(t))},this.removeEventListener=function(e,t){L.debug("MediaStream.removeEventListener(): "+e),void 0===i[e]?L.error("MediaStream.removeEventListener(): Event does not exist = "+e):i[e].listeners=i[e].listeners.filter(function(e){return e.toString()!==t.toString()})},this.addTrack=function(t){L.debug("MediaStream.addTrack(): "+t.id);var n=!1;this.track.forEach(function(e){e.id==t.id&&(n=!0)}),n||this.track.push(t)},this.removeTrack=function(e){L.debug("MediaStream.removeTrack(): "+e.id);for(var t=0;t<this.track.length;t++)if(this.track[t].id==e.id)return void this.track.splice(t,1)},this.removeTrackById=function(e){L.debug("MediaStream.removeTrackById(): "+e);for(var t,n=0;n<this.track.length;n++)if(this.track[n].id==e)return t={type:"removetrack",track:this.track[n]},this.dispatchEvent(t),void this.track.splice(n,1)},this.getTracks=function(){return L.debug("["+this.id+"]MediaStream.getTracks(): "+this.track.length),L.debug(this.track),this.track},this.getAudioTracks=function(){var t=[];return this.track.forEach(function(e){"audio"==e.kind&&t.push(e)}),L.debug("MediaStream.getAudioTracks(): Audio tracks = "+t.length),t},this.getVideoTracks=function(){var t=[];return this.track.forEach(function(e){"video"==e.kind&&t.push(e)}),L.debug("MediaStream.getVideoTracks(): Video tracks = "+t.length),t},this.getTrackById=function(t){var n=null;return L.debug("MediaStream.getTrackById(): "+t),this.track.forEach(function(e){e.id==t&&(n=e)}),n},this.clone=function(){if(L.debug("MediaStream.clone(): Clone mediaStream = "+this.id),this.cloned)return L.debug("MediaStream.clone(): Use cached clone: "+this.cloned.id),this.cloned;var e=new U,t=Re(this.id,"StreamCln#",e._objectId),n=[];e._create({id:t,active:this.active,track:[]},this.peer);for(var i=0;i<this.track.length;i++){var r=this.track[i]._internalClone();e.track.push(r),n.push({tid:this.track[i].id,cid:r.id})}return j.send({cmd:"mediaStreamClone",sid:this.id,cid:e.id,streamPeer:this.peer,trackClones:n},-1),L.debug("MediaStream.clone(): MediaStream cloned = "+e.id+" from = "+this.id),e}},B=function(){var n={};this._objectId=++ce,this.remote=!1,this.readonly=!1,this.contentHint="",this.id="",this.kind="",this.label="",this.muted=!1,this.readyState="",this._enabled=!1,Object.defineProperty(this,"enabled",{get:function(){return this._enabled},set:function(e){void 0===(this._enabled=e)&&L.warn("Set MediaStreamTrack.enabled to undefined."),j.send({cmd:"trackEnabled",trackId:this.id,enabled:e},-1)},configurable:!0}),this._create=function(e){this._update(e),P[this.id]=this},this._update=function(e){e&&(this.contentHint=e.contentHint,this.id=e.id,this.kind=e.kind,this.label=e.label,this._enabled=e.enabled,this.muted=e.muted,this.readyState=e.readyState,this.remote=e.remote,this.readonly=e.readonly,this.settings=e.settings)},this.dispatchEvent=function(e){"started"==e.type?this.onstarted&&this.onstarted(e):"ended"==e.type?this.onended&&this.onended(e):"isolationchange"==e.type?this.onisolationchange&&this.onisolationchange(e):"mute"==e.type?this.onmute&&this.onmute(e):"unmute"==e.type?this.onunmute&&this.onunmute(e):"overconstrained"==e.type?this.onoverconstrained&&this.onoverconstrained(e):L.debug("Undefined media track evt: ",e.type)},this.addEventListener=function(e,t){L.debug("MediaStreamTrack.addEventListener(): "+e),"function"!=typeof t?L.error("MediaStreamTrack.addEventListener(): The listener handler is invalid."):"string"!=typeof e?L.error("MediaStreamTrack.addEventListener(): The event name is invalid."):(void 0===n[e]&&(n[event]={listeners:[]}),n[e].listeners.push(t))},this.removeEventListener=function(e,t){L.debug("MediaStreamTrack.removeEventListener(): "+e),void 0===n[e]?L.error("MediaStreamTrack.removeEventListener(): Event does not exist = "+e):n[e].listeners=n[e].listeners.filter(function(e){return e.toString()!==t.toString()})},this.applyConstraints=function(e){var r=this.id,o=this.settings;return L.debug("MediaStreamTrack.applyConstraints()"),new Promise(function(t,n){var i=new DOMException("applyConstraints failed","OperationError");j.send({cmd:"applyConstraints",constraints:e,trkid:r},-1,function(e){void 0===e.error?(void 0!==e.settings.width&&void 0!==e.settings.height&&(o.width=e.settings.width,o.height=e.settings.height),t()):n(i)})})},this.getConstraints=function(){L.debug("MediaStreamTrack.getConstraints(): Not implemented")},this.getCapabilities=function(){L.debug("MediaStreamTrack.getCapabilities(): Not implemented")},this.getSettings=function(){return L.debug("MediaStreamTrack.getSettings(): "+JSON.stringify(this.settings)),this.settings},this.stop=function(){j.send({cmd:"mediaTrkStop",trkid:this.id})},this._internalClone=function(){var e=new B,t=Re(this.id,"TrackCln#",e._objectId);return e._create({id:t,kind:this.kind,label:this.label,enabled:this.enabled,muted:this.muted,readyState:this.readyState,remote:this.remote,readonly:this.readonly,settings:this.settings}),e},this.clone=function(){var e=this._internalClone();return j.send({cmd:"mediaTrackClone",tid:this.id,cid:e.id},-1),e}},Me=function(){this.stats={},this._create=function(e){this.stats=e,this.type=e.type,this.id=e.id,this.timestamp=e.timestamp,delete this.stats.type,delete this.stats.id,delete this.stats.timestamp},this.names=function(){return Object.keys(this.stats)},this.stat=function(e){return this.stats[e]}},z=function(){function e(e){var t,n=[];for(t in r){var i=r[t];i.type&&i.type===e&&n.push(i)}return n}var n={},r={};this.update=function(e){var t;(t=e)&&("+"===t.op&&(n=null,r={}),t.track&&(n?Object.keys(t.track).forEach(function(e){"enabled"!=e?n[e]=t.track[e]:n._enabled=t.track[e]}):(n=new B)._update(t.track)),t.sources)&&t.sources.forEach(function(t){var n,e=t.source;"-"===t.op?delete r[e]:("+"===t.op&&(delete r[e],r[e]={}),n=r[e],Object.keys(t).forEach(function(e){n[e]=t[e]}))})},Object.defineProperty(this,"track",{get:function(){return n},configurable:!0}),this.getContributingSources=function(){return e(a)},this.getSynchronizationSources=function(){return e(o)}},J=(z.getCapabilities=function(e){if(L.info("RTCRtpReceiver.getCapabilities for kind = "+e),N.receiver&&N.receiver[e])return N.receiver[e]},function(e){var i=this,n=!1,r=(this._cap=F.sender||0,e),o=null,a=null,t=l,s="",d=null,c=null,u=null;this.initPlanB=function(e,t){L.debug("RtcRtpSender.initPlanB"),n=!1,o=t,s=e?e.id:"",a=e,d=new je(i)},this.initUnifiedPlan=function(e,t){e?(n=!0,c=e,d=new je(i),t&&t.sendEncodings):L.error("RTCRtpSender.initUnifiedPlan: Invalid transceiver")},Object.defineProperty(this,"dtmf",{get:function(){return n?(u||(u=new Ee).initUnifiedPlan(r.id,c,this,a),u):r?r.createDTMFSender(a):null},configurable:!0}),Object.defineProperty(this,"rtcpTransport",{get:function(){L.debug("RTCRtpSender.rtcpTransport getter: Not implemented")},configurable:!0}),Object.defineProperty(this,"track",{get:function(){return L.debug("RTCRtpSender.track Transceiver="+(c?c.id:"")+")"),a},configurable:!0}),Object.defineProperty(this,"transport",{get:function(){L.debug("RTCRtpSender.transport getter: Not implemented")},configurable:!0}),Object.defineProperty(this,"id",{get:function(){return L.debug("RTCRtpSender.id:"+s),s},configurable:!0}),Object.defineProperty(this,"proxyState",{get:function(){return t},configurable:!0}),this.setTrack=function(e,t){a=e,o=t},this.removeTrack=function(){a?r?(j.send({cmd:"removeTrack",transceiverId:c?c.id:"",senderId:s},r.id),a=d=null):L.error("RTCRtpSender.removeTrack: invalid peer object."):L.error("RTCRtpSender.removeTrack: track is already removed.")},this.update=function(e){if(r)if(e){if(c)e.id?s=e.id:L.error("RTCRtpSender.update invalid id");else if(s!=e.id||!d)return void L.error("RTCRtpSender.update Invalid state detected, self = "+JSON.stringify(i));e.track&&a&&a._update(e.track),e.parameters&&d&&d.update(e.parameters),t=v}else L.error("RTCRtpSender.update: invalid sender object.");else L.error("RTCRtpSender.update: invalid peer object.")},this.getParameters=function(){return L.debug("RTCRtpSender.getParameters"),r?(t===l&&L.warn("RTCRtpSender.getParameters without peer, use cached value and the behavior will be undefined."),d):(L.error("RTCRtpSender.getParameters: invalid peer object."),null)},this.setParameters=function(e){return L.debug("RTCRtpSender.setParameters"),new Promise(function(n,i){r?j.send({cmd:"senderCmd",senderCmd:f,hint:"setParameter",transceiverId:c?c.id:"",senderId:s,parameters:e.modifiedValues()},r.id,function(e){var t;void 0===e.error?(t=Array.isArray(e.senders)&&0<e.senders.length?e.senders[0]:null)&&t.id==s?(d.update(t.parameters),n()):(L.debug("RTCRtpSender.setParameters invaild response."),t=new DOMException("setParameters failed","OperationError"),i(t)):i(e.error)}):i(new DOMException("RTCRtpSender.setParameters: invalid peer object","OperationError"))})},this.getStats=function(){L.debug("RTCRtpSender.getStats: Not implemented")},this.replaceTrack=function(e){return L.debug("RTCRtpSender.replaceTrack"),new Promise(function(t,n){r?(j.send({cmd:"senderCmd",senderCmd:g,hint:"replaceTrack",transceiverId:c?c.id:"",senderId:s,sid:o?o.id:"",trackId:a?a.id:"",newTrackId:e?e.id:""},r.id,function(e){void 0===e.error?t():n(e.error)}),a=e,d=new je(i)):n(new DOMException("RTCRtpSender.replaceTrack no peer","OperationError"))})}}),je=(J.getCapabilities=function(e){if(L.info("RTCRtpSender.getCapabilities for kind = "+e),N.sender&&N.sender[e])return N.sender[e]},function(t){function e(e){t&&t.proxyState!=l?L.debug("RTCRtpSendParameters."+e):L.warn("RTCRtpSendParameters."+e+": sender is pending.")}var n,i,r,o=[],a=0;o[0]=new Ae;Object.defineProperty(this,"degradationPreference",{get:function(){return e("degradationPreference getter"),n},set:function(e){n=e,a|=s},configurable:!0}),Object.defineProperty(this,"encodings",{get:function(){return e("encodings getter"),o},set:function(e){o=e,a|=c},configurable:!0}),Object.defineProperty(this,"priority",{get:function(){return e("priority getter"),i},set:function(e){i=e,a|=X},configurable:!0}),Object.defineProperty(this,"transactionId",{get:function(){return e("transactionId getter"),r},set:function(e){r=e,a|=K},configurable:!0}),this.update=function(e){0==(a&s)&&(n=e.degradationPreference),0==(a&c)&&e.encodings&&(o=[],e.encodings.forEach(function(e){var t=new Ae;t.update(e),o.push(t)})),0==(a&X)&&(i=e.priority),0==(a&K)&&(r=e.transactionId)},this.modifiedValues=function(){var e={},t=((a&s||void 0!==n)&&(e.degradationPreference=n),[]);return o.forEach(function(e){e=e.modifiedValues();Object.keys(e).length&&t.push(e)}),t.length&&(e.encodings=t),(a&X||void 0!==i)&&(e.priority=i),a=0,e}}),Ae=function(){var t,n,i,r,o,a,s,d=!0,c=0;Object.defineProperty(this,"active",{get:function(){return d},set:function(e){d=e,c|=u.RPF_ACTIVE},configurable:!0}),Object.defineProperty(this,"codecPayloadType",{get:function(){return t},configurable:!0}),Object.defineProperty(this,"dtx",{get:function(){return n},set:function(e){dtx=e,c|=u.RPF_DTX},configurable:!0}),Object.defineProperty(this,"maxBitrate",{get:function(){return i},set:function(e){i=e,c|=u.RPF_MAXBITRATE},configurable:!0}),Object.defineProperty(this,"maxFramerate",{get:function(){return r},set:function(e){r=e,c|=u.RPF_MAXFRAMERATE},configurable:!0}),Object.defineProperty(this,"ptime",{get:function(){return o},set:function(e){o=e,c|=u.RPF_PTIME},configurable:!0}),Object.defineProperty(this,"rid",{get:function(){return a},set:function(e){a=e,c|=u.RPF_RID},configurable:!0}),Object.defineProperty(this,"scaleResolutionDownBy",{get:function(){return s},set:function(e){s=e,c|=u.RPF_SCALE_RESOLUTION_DOWNBY},configurable:!0}),this.update=function(e){0==(c&u.RPF_ACTIVE)&&(d=e.active),0==(c&u.RPF_CODEPAYLOADTYPE)&&(t=e.codecPayloadType),0==(c&u.RPF_DTX)&&(n=e.dtx),0==(c&u.RPF_MAXBITRATE)&&(i=e.maxBitrate),0==(c&u.RPF_MAXFRAMERATE)&&(r=e.maxFramerate),0==(c&u.RPF_PTIME_)&&(o=e.ptime),0==(c&u.RPF_RID)&&(a=e.rid),0==(c&u.RPF_SCALE_RESOLUTION_DOWNBY)&&(s=e.scaleResolutionDownBy)},this.modifiedValues=function(){var e={};return(c&u.RPF_ACTIVE||void 0!==d)&&(e.active=d),(c&u.RPF_CODEPAYLOADTYPE||void 0!==t)&&(e.codecPayloadType=t),(c&u.RPF_DTX||void 0!==n)&&(e.dtx=n),(c&u.RPF_MAXBITRATE||void 0!==i)&&(e.maxBitrate=i),(c&u.RPF_MAXFRAMERATE||void 0!==r)&&(e.maxFramerate=r),(c&u.RPF_PTIME||void 0!==o)&&(e.ptime=o),(c&u.RPF_RID||void 0!==a)&&(e.rid=a),(c&u.RPF_SCALE_RESOLUTION_DOWNBY||void 0!==s)&&(e.scaleResolutionDownBy=s),c=0,e}},Ve={Monitor:1,Window:2,Camera:3},Fe="VDI_Mon",h={CREATE:1,SEND:2,SET_BUFFER_AMOUNT_LOW_THRESHOLD:3,CLOSE:4};return{initSDK:function(e,t,n,i){if("function"!=typeof n)return L.error("initSDK(): The event callback function is not valid."),!1;L.info("setVMEventCallback(): Set event callback"),ve=n,re=t||"",r=e,L.info("init(): VMware VDI shim version = "+E),i&&(Se=i);n=1;return i&&!isNaN(i.numOfCallConfigs)&&(n=t=(t=0<(t=parseInt(Number(i.numOfCallConfigs)))?t:1)<=3?t:3),Se.numOfCallConfigs=n,"function"==typeof window.getWindowReference?window.getWindowReference().then(function(e){L.info("init(): HWND: "+e),M.hwnd=e,(j=new Ie).init()},function(e){L.error("init(): Failed to retrieve window handle: "+e.message)}):(L.info("init() webapp with HWND: 0"),M.hwnd=O,(j=new Ie).init()),!0},getCallConfig:function(e){return Ce[e]},newPeerConnection:function(e,t){return this.newPeerConnectionEx(e,t)},newPeerConnectionEx:function(e,t,n){if(j){if(j.isSocketConnected()){var i=new Te(e);if(F.sender)i.createOffer=i.createOfferV1,i.createAnswer=i.createAnswerV1,i.setRemoteDescription=i.setRemoteDescriptionV1,i.setLocalDescription=i.setLocalDescriptionV1,i.addIceCandidate=i.addIceCandidateV1,i.getStats=i.getStatsV1,i.addTrack=i.addTrackImplV1,i.removeTrack=i.removeTrackImplV1,i.getSenders=i.getSendersImplV1,i.getTransceivers=i.getTranceiversImplV1,i.addTransceiver=i.addTransceiverImplV1;else{if(i.isUnifiedPlan())throw L.error("createPeerConnection failed due to endpoint does not support unified plan"),"endpoint does not support unified plan";i.createOffer=i.createOfferV0,i.createAnswer=i.createAnswerV0,i.setRemoteDescription=i.setRemoteDescriptionV0,i.setLocalDescription=i.setLocalDescriptionV0,i.addIceCandidate=i.addIceCandidateV0,i.getStats=i.getStatsV0}return i.createDataChannel=i.createDataChannelImplV1,I[i.id]=i,j.send({cmd:"createPeerConnection",arg1:e,arg2:t,callConfig:n},i.id),L.debug("createPeerConnection(): Create peer: "+i.id),i}L.error("createPeerConnection: WebSocket is not in connected state")}else L.error("createPeerConnection: gRequestManager is not created yet.")},newMediaStream:function(e){var t=new U;return t.createMediaStream(e),t},getDisplayMedia:function(e){return this.getDisplayMediaEx(e)},getDisplayMediaEx:function(e,t){if(j.isSocketConnected())return new Promise(function(n,i){L.debug("getDisplayMediaShim(): Constraints = "+JSON.stringify(e)),j.send({cmd:"getDisplayMediaShim",constraints:e,callConfig:t},-1,function(e){var t;void 0===e.error?((t=new U)._create(e.stream,p),L.debug("getDisplayMediaShim(): Media ="+t.id),n(t)):i(e.error)})});L.error("getDisplayMediaShim: WebSocket is not in connected state")},getUserMedia:function(e){return this.getUserMediaEx(e)},getUserMediaEx:function(e,t){if(!j.isSocketConnected())return Promise.reject({name:"NotFoundError",message:"WebSocket is not in connected state"});if(void 0!==e.video&&void 0!==e.video.mandatory&&void 0!==e.video.mandatory.sourceId&&void 0!==me[e.video.mandatory.sourceId]){var n=0,i=0,r=0,o=!1,a=e.video.mandatory.sourceId,s=e.video.mandatory.minWidth,d=e.video.mandatory.maxWidth,c=e.video.mandatory.minHeight,u=e.video.mandatory.maxHeight,l=e.video.mandatory.maxFrameRate,h=s,f=c,g={width:0,height:0},v={width:0,height:0},a=(me[a].forEach(function(e){(void 0===s||e.width>=s)&&(void 0===d||e.width<=d)&&(void 0===c||e.height>=c)&&(void 0===u||e.height<=u)&&(void 0===l||e.fps>=l)?(e.width*e.height>g.width*g.height&&(g=e),h&&f&&h*e.height==f*e.width&&e.width*e.height>v.width*v.height&&(v=e)):(void 0!==s&&e.width>=s||void 0!==d&&e.width>=d)&&(o=!0)}),0<v.width?v:g);if(a&&(n=a.width,i=a.height,r=a.fps),0<n&&0<i&&0<r)L.debug("Constraints: "+JSON.stringify(e)+" ==> "+n+"x"+i+" @"+r+":"+(l||"undefined")),l&&(e.video.mandatory.origFps=l),e.video.mandatory.maxFrameRate=r,e.video.mandatory.maxWidth=e.video.mandatory.minWidth=n,e.video.mandatory.maxHeight=e.video.mandatory.minHeight=i;else{if(!o)return L.debug("getUserMediaShim(): constraints does not match."),void reject({name:"OverconstrainedError",message:null});L.debug("getUserMediaShim(): low resolution video forward to client.")}}return new Promise(function(i,r){j.send({cmd:"getUserMediaShim",constraints:e,callConfig:t},-1,function(e){var t,n;void 0===e.error?(t=null,void 0!==e.clone&&((t=new U)._create(e.clone,p),L.debug("Media cloned:"+t.id)),(n=new U)._create(e.stream,p),n.cloned=t,L.debug("Media:"+n.id),i(n)):(new DOMException("Abort","AbortError"),r(e.error))})})},enumerateDevices:function(){return j.isSocketConnected()?new Promise(function(e,n){j.send({cmd:"enumDevices"},-1,function(t){void 0===t.error?(e(t.devices),void 0!==t.caps&&Object.keys(t.caps).forEach(function(e){me[e]=t.caps[e]})):n("enumDevices cancelled.")})}):(L.info("enumerateDevicesShim(): Use fallback mode."),new Promise(function(t,n){ge.call(navigator.mediaDevices).then(function(e){t(e),j.isSocketConnected()&&(L.info("enumerateDevicesShim(): [Resolve] Fallback cancelled. Invoke device change."),j.invokeDeviceChange())},function(e){j.isSocketConnected()?(L.info("enumerateDevicesShim(): [Reject] Fallback cancelled. Invoke device change."),t([]),j.invokeDeviceChange()):n(e)})}))},onVideoCreated:function(e,t){if(j.isSocketConnected()){L.debug("newVideoElement: New video element from app.");for(var n=Object.keys(D),i=0;i<n.length;i++){var r=n[i];if(D[r]._rawVideo===e)return void L.debug("newVideoElement(): Video already found")}t=new Oe(e,t);D[t._id]=t,e._context=t}else L.error("newVideoElement: WebSocket is not in connected state")},onAudioCreated:function(e,t){if(j.isSocketConnected()){L.debug("newAudioElement(): A new audio element created.");for(var n=Object.keys(pe),i=0;i<n.length;i++){var r=n[i];if(pe[r]._rawAudio===e)return void L.debug("newAudioElement(): Audio already found")}t=new ke(e,t);pe[t._id]=t,e._context=t}else L.error("newAudioElement: WebSocket is not in connected state")},onVideoDisposed:function(e,t){e&&e._context&&e._context.disposeVideo();e=e&&e._context?e._context._id:void 0;L.info("disposeElement video id="+e)},onAudioDisposed:function(e,t){e&&e._context&&e._context._id;L.info("disposeElement audio id="+_id)},playRingtone:function(e,r,t){var o,a;j.isSocketConnected()?r?(e,L.debug("playNotifyAudio(): id = "+e+" src = "+r+" loop = "+t),void 0===(o=i[e])&&(o=se++,i[e]=o),j.send({cmd:"notifyAudio",action:"play",src:r,audid:o,loop:t},-1),(a=new XMLHttpRequest).open("GET",r,!0),a.responseType="arraybuffer",a.onreadystatechange=function(){var e,t,n,i;a.readyState==XMLHttpRequest.DONE&&200==a.status?(e=16+a.response.byteLength,(t=new Uint8Array(16))[0]=65,t[1]=78,t[2]=84,t[3]=70,t[4]=e>>24&255,t[5]=e>>16&255,t[6]=e>>8&255,t[7]=255&e,t[8]=o>>24&255,t[9]=o>>16&255,t[10]=o>>8&255,t[11]=255&o,n=new Uint8Array(e),i=new Uint8Array(a.response),n.set(t,0),n.set(i,16),j.sendBinary(n),L.debug("onreadystatechange(): Send "+e+"bytes")):L.debug("onreadystatechange(): Download "+r+" status = "+a.status)},a.send()):L.error("playNotifyAudio(): src cannot be null or undefined"):L.error("playNotifyAudio(): WebSocket is not in connected state")},pauseRingtone:function(e){var t;j.isSocketConnected()?(L.debug("pauseNotifyAudio(): id = "+e),void 0===(t=i[e])?L.warn("pauseNotifyAudio(): id = "+e+" did not play yet."):j.send({cmd:"notifyAudio",action:"pause",audid:t},-1)):L.error("playNotifyAudio: WebSocket is not in connected state")},setVideoClipRegion:function(e,t,n){L.debug("setVideoClipRegion: "+e+", "+JSON.stringify(t)),j.isSocketConnected()?(e={cmd:"customClipRect",op:e?0:1,clip:JSON.parse(JSON.stringify(t))},(t=ye(n))&&(ie(n),e.frame=t),j.send(e,-1)):L.error("setVideoClipRegion: WebSocket is not in connected state.")},getReceiverCapabilities:function(e){return L.debug("getCapabilitiesShim"),z.getCapabilities(e)},setSinkId:function(e,t){var n;j.isSocketConnected()?(void 0===(n=i[e])&&(n=se++,i[e]=n),L.debug("setSinkId id = "+n+" srcId = "+e+" Value = "+t),j.send({cmd:"setSinkId",deviceId:t,audioId:n,srcId:e,context:"global"},-1,function(e){})):L.error("setSinkId: WebSocket is not in connected state")},setPrimarySinkId:function(e){L.debug("setDefaultSinkId = "+e),j.isSocketConnected()?j.send({cmd:"setDefaultSinkId",deviceId:e},-1):L.error("setDefaultSinkId: WebSocket is not in connected state")},isFeatureSupported:function(e){var t;return"string"!=typeof e?(L.debug("isFeatureSupported(): Invalid feature parameter"),!1):!(!j||j.state!==_)&&("datachannel"===e?F.datachannel?1==F.datachannel||(L.debug("isFeatureSupported(): disable datachannel by settings."),!1):(L.debug("isFeatureSupported(): disable datachannel for old client."),!1):(t=!1,(t=Array.isArray(A)&&-1!=A.indexOf(e)?!0:t)||L.debug("isFeatureSupported(): Input feature string not supported = "+e),t))},getScreensInfo:function(){if(L.debug("getScreensAsync get called."),j.isSocketConnected())return new Promise(function(f,g){var e=0;F.getScreens&&F.getScreens&$&&(e=1),j.send({cmd:"getScreens",bounds:e},-1,function(e){if(Array.isArray(e))f(V=t=e);else if(e.screens&&Array.isArray(e.screens)){for(var t=[],n=0;n<e.screens.length;n++){var i=e.screens[n].w,r=e.screens[n].h,o=e.screens[n].id,a=e.screens[n].bounds,s=e.screens[n].imageData;if(0<i&&0<r&&o&&a&&s){for(var d=window.atob(s),c=d.length,u=new Uint8ClampedArray(c),l=0;l<c;l++)u[l]=d.charCodeAt(l);s=new ImageData(u,i,r),i=new Pe(o,"Screen "+o,s,a);t.push(i),L.debug("Screen:"+o+":  image size:"+c)}else L.error("Invalid screen data:"+JSON.stringify(e.screens[n]))}f(V=t)}else{var h=e.error&&e.error.message?e.error.message:"Invalid getScreen response";g(new DOMException(h,"OperationError"))}})});L.error("getScreensAsync: WebSocket is not in connected state")},onScreenSelected:function(e){L.debug("setScreenSharePanelId = "+e+" for getDisplayMedia"),j.isSocketConnected()?j.send({cmd:"setScreenId",scrnId:e,numScreens:V.length},-1):L.error("setScreenSharePanelId: WebSocket is not in connected state")},onWindowSessionConnected:function(e){L.info("connectedStateChanged called "+e),j&&(j.state===_&&j.send({cmd:"connectedStateChanged",connectionState:!0===e?1:0},-1),!0===e?(j.sendVdiClientEventsOnError=!0,j.startPolling(j.shortPollingIntervalMs,j.shortPollingTimeout,j.sendEvents)):(j.sendVdiClientEventsOnError=!1,j.isHorizonRegistryPresent=!1,L.info("connectedStateChanged(): isHorizonRegistryPresent false"),j.stopPolling()))}}});